---
title: 'Q3: PROTAC reversal'
author: "Dominique Paul"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

suppressPackageStartupMessages({
  library(dplyr)
  library(openxlsx)
  library(hrbrthemes)
  library(ggplot2)
})

hrbrthemes::import_roboto_condensed()
extrafont::loadfonts()
```

# Question 3:

Our RNA: are there any genes that treated by the PROTAC before/after DEX that could be reversed but which could not by the inhibitors or vice versa?

We have performed experiments where we first exposed cells to either (1) DEX, (2) inhibitors, or (3) KH PROTAC for a substantial time and then added inhibitors or the KH PROTAC in case (1) or DEX in cases (2) and (3). We would like to see whether the genes which were activated by DEX but then returned to a normal expression by the KH PROTAC, where a similar treatment by the inhibitors could not lead to such an effect and vice versa.

In our RNAseq, are there any genes that Protac after dex or before dex could reverse or partially reverse that cort113 or mifepristone could not? do these gene show GR binding according to Reddy's chip data?

```{r load data}
res_int_all <- readRDS(file="../data/results/DE_our_data.rds")
names(res_int_all)

# The threshold we choose for which values count as DE or not
fdr_thresh <- 0.05

# Load the control data for the 2+16 experiment
control216 <- res_int_all[["2h DEX > 16h DEX+DMSO"]]
control162 <- res_int_all[["16h DMSO > 2h DEX+DMSO"]]
```


# figure 6d

## 2h > 16h (18h dex)

*Def. 1:* We consider "reversed by inhibitor" to mean: "Is DE in '2h DEX > 16h DEX+DMSO' but not in '2h DEX > 16h DEX+Cort113'". We look at both inhibitors and the PROTAC

```{r def1, fig.width=10, fig.height=7, message=FALSE}
# Load inhibitors/Protac data
cort216 <- res_int_all[["2h DEX > 16h DEX+Cort113"]]
mif216 <- res_int_all[["2h DEX > 16h DEX+MIF"]]
protac216 <- res_int_all[["2h DEX > 16h DEX+KH-103"]]

# merge the respective FDRs onto DF
merged216 <- control216 %>% 
  tibble::rownames_to_column() %>% 
  left_join(cort216 %>% 
              tibble::rownames_to_column() %>%
              dplyr::select(rowname, logFC, FDR), suffix=c("","_cort"), by="rowname") %>%
  left_join(mif216 %>% 
              tibble::rownames_to_column() %>%
              dplyr::select(rowname, logFC, FDR), suffix=c("","_MIF"), by="rowname") %>%
  left_join(protac216 %>% 
              tibble::rownames_to_column() %>%
              dplyr::select(rowname, logFC, FDR), suffix=c("","_KH"), by="rowname")

# Using a FDR of 0.05, how many clear reversals do we have?
merged216$cort_reversed <- ifelse(merged216$FDR < 0.05 & merged216$FDR_cort >= 0.05, TRUE, FALSE)
merged216$MIF_reversed <- ifelse(merged216$FDR < 0.05 & merged216$FDR_MIF >= 0.05, TRUE, FALSE)
merged216$KH_reversed <- ifelse(merged216$FDR < 0.05 & merged216$FDR_KH >= 0.05, TRUE, FALSE)

# transform from wide to long
merged216_long <- reshape2::melt(merged216, 
                id.vars="rowname",
                  measure.vars=c("logFC", "logFC_cort", "logFC_MIF", "logFC_KH")) %>%
  mutate(Group=factor(variable))
levels(merged216_long$Group) <- c("DEX.18h", "Cort", "MIF", "KH")

# sort rownames in descending order of control logFCs
rnames <- merged216_long[merged216_long$Group == "DEX.18h",] %>% arrange(desc(value)) %>% pull(rowname)
merged216_long$rowname <- factor(merged216_long$rowname, levels=rnames)

# unique protac reversals
merged216 <- merged216 %>% arrange(logFC)
rnames_kh_reversal <- merged216[merged216$KH_reversed == TRUE & 
                                  merged216$cort_reversed == F & 
                                  merged216$MIF_reversed == F,"rowname"]

merged216[merged216$rowname %in% rnames_kh_reversal,"KH_reversed"] <- TRUE
```


```{r, fig.width=10, fig.height=7, message=FALSE}
plt1 <- ggplot(merged216_long[merged216_long$rowname %in% rnames_kh_reversal,]) +
  geom_point(aes(x=rowname, y=value, color=Group)) +
  theme_ipsum_rc() +
  labs(title="Genes reversed by Protac but not by inhibitors",
       subtitle="2h DEX > 16h DEX + Inhibitor/Protac",
       x="", y="") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    scale_color_manual(values=c(DEX.18h="Black", Cort="#7ef2b4", MIF="#dda6ff", KH="#ff000d"))
plt1

ggsave(file="../docs/assets/Q3_1_reversal216.pdf", plt1, width=12, height=7)
```

### Sign flips / reversals

We search for cases where an inhibitor or the protac has flipped the sign of a logFC. We filter for genes where the gene was DE in both the comparison with the control as well as inhibitor/protac. We apply the additional filter than the sign of the logFC has changed with reference to the control experiment.

```{r, fig.width=10, fig.height=7, results="asis"}
# Check for flips in sign
merged216$cort_flipped <- ifelse(merged216$FDR < 0.05 & merged216$FDR_cort < 0.05 & 
                                   ((merged216$logFC * merged216$logFC_cort) < 0), TRUE, FALSE)
merged216$MIF_flipped <- ifelse(merged216$FDR < 0.05 & merged216$FDR_MIF < 0.05 & 
                                   ((merged216$logFC * merged216$logFC_MIF) < 0), TRUE, FALSE)
merged216$KH_flipped <- ifelse(merged216$FDR < 0.05 & merged216$FDR_KH < 0.05 & 
                                   ((merged216$logFC * merged216$logFC_KH) < 0), TRUE, FALSE)

plot_logFCs_216 <- function(rownames_subset, title){
  # cort
  plt <- ggplot(merged216_long[merged216_long$rowname %in% rownames_subset,]) +
    geom_point(aes(x=rowname, y=value, color=Group)) +
    theme_ipsum_rc() +
    labs(title=title,
         subtitle="2h DEX > 16h DEX + Inhibitor/Protac",
         x="", y="") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      scale_color_manual(values=c(DEX.18h="Black", Cort="#7ef2b4", MIF="#dda6ff", KH="#ff000d"))
  plt
}

rnames_flipped_cort <- merged216 %>% dplyr::filter(cort_flipped == TRUE) %>% pull(rowname)
rnames_flipped_mif <- merged216 %>% dplyr::filter(MIF_flipped == TRUE) %>% pull(rowname)
rnames_flipped_kh <- merged216 %>% dplyr::filter(KH_flipped == TRUE) %>% pull(rowname)

plt_flipped_cort <- plot_logFCs_216(rnames_flipped_cort, "Genes flipped by cort")
plt_flipped_mif <- plot_logFCs_216(rnames_flipped_mif, "Genes flipped by MIF")
plt_flipped_kh <- plot_logFCs_216(rnames_flipped_kh, "Genes flipped by KH")

# Save all plots
ggsave(file="../docs/assets/Q3_1_flipped_cort_216.pdf", plt_flipped_cort, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_mif_216.pdf", plt_flipped_mif, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_kh_216.pdf", plt_flipped_kh, width=12, height=7)

# Show all plots
cat("\n\n### Flipped effects {.tabset} \n\n")
cat("\n\n#### Cort \n\n")
plt_flipped_cort
cat("\n\n#### MIF  \n\n")
plt_flipped_mif
cat("\n\n#### KH \n\n")
plt_flipped_kh

# plot genes flipped by the respective markers only
rnames_flipped_cort_only <- rnames_flipped_cort[!(rnames_flipped_cort %in% c(rnames_flipped_mif, rnames_flipped_kh))]
rnames_flipped_mif_only <- rnames_flipped_mif[!(rnames_flipped_mif %in% c(plt_flipped_kh, rnames_flipped_kh))]
rnames_flipped_kh_only <- rnames_flipped_mif[!(rnames_flipped_mif %in% c(rnames_flipped_mif, plt_flipped_cort))]

plt_flipped_cort_only <- plot_logFCs_216(rnames_flipped_cort_only, "Genes flipped by cort only")
plt_flipped_mif_only <- plot_logFCs_216(rnames_flipped_mif_only, "Genes flipped by MIF only")
plt_flipped_kh_only <- plot_logFCs_216(rnames_flipped_kh_only, "Genes flipped by KH only")

# Save all plots
ggsave(file="../docs/assets/Q3_1_flipped_cort_only_216.pdf", plt_flipped_cort_only, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_mif_only_216.pdf", plt_flipped_mif_only, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_kh_only_216.pdf", plt_flipped_kh_only, width=12, height=7)

# Show all plots
cat("\n\n### Flipped effects with unique genes per treatment {.tabset} \n\n")
cat("\n\n#### Cort \n\n")
plt_flipped_cort_only
cat("\n\n#### MIF  \n\n")
plt_flipped_mif_only
cat("\n\n#### KH \n\n")
plt_flipped_kh_only
```

## Plots from Mahshids summary

## 1. Only those genes which are significant in Dex 18h, ns in 2h>KH103 but are significant in the same direction (+/-) as Dex 18h in 2h dex>mif and 2h dex>cort113

```{r, fig.width=14, fig.height=5}
merged216$category1 <- (merged216$FDR < 0.05) & 
  (merged216$FDR_KH > 0.05) & 
  (merged216$FDR_MIF < 0.05) & (merged216$FDR_cort < 0.05) & 
  (merged216$logFC_MIF * merged216$logFC_cort > 0) & # checks that mif and cort have same sign
  (merged216$logFC * merged216$logFC_cort > 0)  # checks that mif and 2h dex have the same sign

rnames_flipped_cat1 <- merged216 %>% dplyr::filter(category1 == TRUE) %>% pull(rowname)

# fig 6d.2a
plot_logFCs_216(rnames_flipped_cat1, "Category 1")
ggsave(filename="../data/00_paper_figures/6d2a.pdf", width = 14, height=5)
```

## 2. Only those genes which are significant in Dex 18h, ns in 2h dex> KH103 but are significant in the opposite direction as Dex 18h in 2h dex>mif and 2h dex > cort113

```{r, fig.width=7, fig.height=5}
merged216$category2 <- (merged216$FDR < 0.05) & 
  (merged216$FDR_KH > 0.05) & 
  (merged216$FDR_MIF < 0.05) & (merged216$FDR_cort < 0.05) & 
  (merged216$logFC_MIF * merged216$logFC_cort > 0) & # checks that mif and cort have same sign
  (merged216$logFC * merged216$logFC_cort < 0)  # checks that mif and 2h dex have different sign

rnames_flipped_cat2 <- merged216 %>% dplyr::filter(category2 == TRUE) %>% pull(rowname)

# fig 6d.2b
plot_logFCs_216(rnames_flipped_cat2, "Category 2")
ggsave(filename="../data/00_paper_figures/6d2b.pdf", width = 7, height=5)
```

## 3. Only those genes which are significant in Dex 18h, and are ns or significant in the same direction as Dex 18h for 2h dex>mif and 2h dex>cort113 but are significant in the opposite direction as Dex 18h in 2h dex>KH-103


```{r, fig.width=7, fig.height=5}
merged216$category3 <- (merged216$FDR < 0.05) & 
  ((merged216$FDR_MIF < 0.05) | (merged216$logFC * merged216$logFC_MIF > 0)) & # 18h DEX and MIF point in same direction
  ((merged216$FDR_cort < 0.05) | (merged216$logFC * merged216$logFC_cort > 0)) & # 18h DEX and MIF point in same direction
  ((merged216$FDR_KH < 0.05) & (merged216$logFC * merged216$logFC_KH < 0)) # 18h DEX and KH have different logFC signs while KH is significant

rnames_flipped_cat3 <- merged216 %>% dplyr::filter(category3 == TRUE) %>% pull(rowname)

# fig 6d.2c
plot_logFCs_216(rnames_flipped_cat3, "Category 3")
ggsave(filename="../data/00_paper_figures/6d2c.pdf", width = 7, height=5)
```


## 4. Only those genes which are significant in Dex 18h, and are significant in the opposite direction as Dex 18h in all three conditions of 2h dex>KH-103, 2h dex>MIF, 2h dex>Cort113


```{r, fig.width=14, fig.height=5}
merged216$category4 <- (merged216$FDR < 0.05) & 
  (merged216$logFC * merged216$logFC_KH < 0) & (merged216$FDR_KH < 0.05) & # KH is significant in other direction as 2h DEX
  (merged216$logFC * merged216$logFC_MIF < 0) & (merged216$FDR_MIF < 0.05) & # MIF is significant in other direction as 2h DEX
  (merged216$logFC * merged216$logFC_cort < 0) & (merged216$FDR_cort < 0.05) # cort is significant in other direction as 2h DEX

rnames_flipped_cat4 <- merged216 %>% dplyr::filter(category4 == TRUE) %>% pull(rowname)

# fig 6d.2d
plot_logFCs_216(rnames_flipped_cat4, "Category 4")
ggsave(filename="../data/00_paper_figures/6d2d.pdf", width = 14, height=5)
```

# Figure 6c

## 16h > 2h (2h dex)

*Def. 2:* "Is DE from 16h DEX > 2h DEX+DMSO but is not DE in 16h DEX > 2h DEX+Cort113 experiment"


```{r def2}
# Load inhibitors/Protac data
cort162 <- res_int_all[["16h Cort113 > 2h DEX+Cort113"]]
mif162 <- res_int_all[[ "16h MIF  > 2h DEX+MIF"]]
protac162 <- res_int_all[["16h KH-103 > 2h DEX+KH-103"]]

# merge the respective FDRs onto DF
merged162 <- control162 %>% 
  tibble::rownames_to_column() %>% 
  left_join(cort162 %>% 
              tibble::rownames_to_column() %>%
              dplyr::select(rowname, logFC, FDR), suffix=c("","_cort"), by="rowname") %>%
  left_join(mif162 %>% 
              tibble::rownames_to_column() %>%
              dplyr::select(rowname, logFC, FDR), suffix=c("","_MIF"), by="rowname") %>%
  left_join(protac162 %>% 
              tibble::rownames_to_column() %>%
              dplyr::select(rowname, logFC, FDR), suffix=c("","_KH"), by="rowname")

# Using a FDR of 0.05, how many clear reversals do we have?
merged162$cort_reversed <- ifelse(merged162$FDR < 0.05 & merged162$FDR_cort >= 0.05, TRUE, FALSE)
merged162$MIF_reversed <- ifelse(merged162$FDR < 0.05 & merged162$FDR_MIF >= 0.05, TRUE, FALSE)
merged162$KH_reversed <- ifelse(merged162$FDR < 0.05 & merged162$FDR_KH >= 0.05, TRUE, FALSE)

# transform from wide to long
merged162_long <- reshape2::melt(merged162,
                id.vars="rowname",
                  measure.vars=c("logFC", "logFC_cort", "logFC_MIF", "logFC_KH")) %>%
  mutate(Group=factor(variable))
levels(merged162_long$Group) <- c("DEX.2h", "Cort", "MIF", "KH")

# sort rownames in descending order of control logFCs
rnames <- merged162_long[merged162_long$Group == "DEX.2h",] %>% arrange(desc(value)) %>% pull(rowname)
merged162_long$rowname <- factor(merged162_long$rowname, levels=rnames)

# unique protac reversals
merged162 <- merged162 %>% arrange(logFC)
rnames_kh_reversal <- merged216[merged162$KH_reversed == TRUE & 
                                  merged162$cort_reversed == F & 
                                  merged162$MIF_reversed == F,"rowname"]

merged162[merged162$rowname %in% rnames_kh_reversal,"KH_reversed"] <- TRUE
``` 

Because we have a lot of genes to show in one plot for the 16h > 2h experiment, we split them into two groups. One plot shows the genes for which the control logFC is >0 and the other <0.

```{r plots, fig.width=14, fig.height=5}
# split the long formatted dataset into two groups
data_plt <- merged162_long[merged162_long$rowname %in% rnames_kh_reversal,]
data <- data_plt[data_plt$Group == "DEX.2h",]
rnames_plt1 <- data[data$value > 0,"rowname"]
rnames_plt2 <- data[data$value <= 0,"rowname"]
data_plt1 <- data_plt[data_plt$rowname %in% rnames_plt1,]
data_plt2 <- data_plt[data_plt$rowname %in% rnames_plt2,]

plt2_1 <- ggplot(data_plt1) +
  geom_point(aes(x=rowname, y=value, color=Group)) +
  theme_ipsum_rc() +
  labs(title="Genes reversed by Protac but not by inhibitors",
       subtitle="16h Inhibitor/Protac > 2h Inhibitor/Protac + DEX",
       x="", y="") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    scale_color_manual(values=c(DEX.2h="Black", Cort="#7ef2b4", MIF="#dda6ff", KH="#ff000d"))

plt2_2 <- ggplot(data_plt2) +
  geom_point(aes(x=rowname, y=value, color=Group)) +
  theme_ipsum_rc() +
  labs(title="Genes reversed by Protac but not by inhibitors",
       subtitle="16h Inhibitor/Protac > 2h Inhibitor/Protac + DEX",
       x="", y="") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    scale_color_manual(values=c(DEX.2h="Black", Cort="#7ef2b4", MIF="#dda6ff", KH="#ff000d"))

# show the plots
plt2_1
plt2_2

ggsave(file="../docs/assets/Q3_2_reversal162_p1.pdf", plt2_1, width=24, height=8)
ggsave(file="../docs/assets/Q3_3_reversal162_p2.pdf", plt2_2, width=24, height=8)
```


### Sign flips / reversals

We search for cases where an inhibitor or the protac has flipped the sign of a logFC. We filter for genes where the gene was DE in both the comparison with the control as well as inhibitor/protac. We apply the additional filter than the sign of the logFC has changed with reference to the control experiment.

```{r, fig.width=10, fig.height=7, results="asis"}
# Check for flips in sign
merged162$cort_flipped <- ifelse(merged162$FDR < 0.05 & merged162$FDR_cort < 0.05 & 
                                   ((merged162$logFC * merged162$logFC_cort) < 0), TRUE, FALSE)
merged162$MIF_flipped <- ifelse(merged162$FDR < 0.05 & merged162$FDR_MIF < 0.05 & 
                                   ((merged162$logFC * merged162$logFC_MIF) < 0), TRUE, FALSE)
merged162$KH_flipped <- ifelse(merged162$FDR < 0.05 & merged162$FDR_KH < 0.05 & 
                                   ((merged162$logFC * merged162$logFC_KH) < 0), TRUE, FALSE)

plot_logFCs_162 <- function(rownames_subset, title){
  # cort
  plt <- ggplot(merged162_long[merged162_long$rowname %in% rownames_subset,]) +
    geom_point(aes(x=rowname, y=value, color=Group)) +
    theme_ipsum_rc() +
    labs(title=title,
         subtitle="2h DEX > 16h DEX + Inhibitor/Protac",
         x="", y="") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
      scale_color_manual(values=c(DEX.2h="Black", Cort="#7ef2b4", MIF="#dda6ff", KH="#ff000d"))
  plt
}

rnames_flipped_cort <- merged162 %>% dplyr::filter(cort_flipped == TRUE) %>% pull(rowname)
rnames_flipped_mif <- merged162 %>% dplyr::filter(MIF_flipped == TRUE) %>% pull(rowname)
rnames_flipped_kh <- merged162 %>% dplyr::filter(KH_flipped == TRUE) %>% pull(rowname)

print(kableExtra::kable(data.frame("Inhibitor"=c("Cort only", "MIF only", "KH only"), 
                                   "length"=c(length(rnames_flipped_cort), 
                                              length(rnames_flipped_mif), 
                                              length(rnames_flipped_kh)))))

plt_flipped_cort <- plot_logFCs_162(rnames_flipped_cort, "Genes flipped by cort")
plt_flipped_mif <- plot_logFCs_162(rnames_flipped_mif, "Genes flipped by MIF")
plt_flipped_kh <- plot_logFCs_162(rnames_flipped_kh, "Genes flipped by KH")

# Save all plots
ggsave(file="../docs/assets/Q3_1_flipped_cort_216.pdf", plt_flipped_cort, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_mif_216.pdf", plt_flipped_mif, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_kh_216.pdf", plt_flipped_kh, width=12, height=7)

# Show all plots
cat("\n\n### Flipped effects {.tabset} \n\n")
cat("\n\n#### Cort \n\n")
plt_flipped_cort
cat("\n\n#### MIF  \n\n")
plt_flipped_mif
cat("\n\n#### KH \n\n")
plt_flipped_kh

# plot genes flipped by the respective markers only
rnames_flipped_cort_only <- rnames_flipped_cort[!(rnames_flipped_cort %in% c(rnames_flipped_mif, rnames_flipped_kh))]
rnames_flipped_mif_only <- rnames_flipped_mif[!(rnames_flipped_mif %in% c(plt_flipped_kh, rnames_flipped_kh))]
rnames_flipped_kh_only <- rnames_flipped_mif[!(rnames_flipped_mif %in% c(rnames_flipped_mif, plt_flipped_cort))]

print(kableExtra::kable(data.frame("Inhibitor"=c("Cort only", "MIF only", "KH only"), 
                                   "length"=c(length(rnames_flipped_cort_only), 
                                              length(rnames_flipped_mif_only), 
                                              length(rnames_flipped_kh_only)))))

plt_flipped_cort_only <- plot_logFCs_162(rnames_flipped_cort_only, "Genes flipped by cort only")
plt_flipped_mif_only <- plot_logFCs_162(rnames_flipped_mif_only, "Genes flipped by MIF only")
plt_flipped_kh_only <- plot_logFCs_162(rnames_flipped_kh_only, "Genes flipped by KH only")

# Save all plots
ggsave(file="../docs/assets/Q3_1_flipped_cort_only_216.pdf", plt_flipped_cort_only, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_mif_only_216.pdf", plt_flipped_mif_only, width=12, height=7)
ggsave(file="../docs/assets/Q3_1_flipped_kh_only_216.pdf", plt_flipped_kh_only, width=12, height=7)

# Show all plots
cat("\n\n### Flipped effects with unique genes per treatment {.tabset} \n\n")
cat("\n\n#### Cort \n\n")
plt_flipped_cort_only
cat("\n\n#### MIF  \n\n")
plt_flipped_mif_only
cat("\n\n#### KH \n\n")
plt_flipped_kh_only
```


## Plots according to document

## 1. Only those genes which are significant in Dex 2h, ns in KH103>2h dex but are significant in the same direction (+/-) as Dex 2h in mif>2h dex and cort>2h dex

```{r, fig.width=14, fig.height=5}
merged162$category1 <- (merged162$FDR < 0.05) & 
  (merged162$FDR_KH > 0.05) & 
  (merged162$FDR_MIF < 0.05) & (merged162$FDR_cort < 0.05) & 
  (merged162$logFC_MIF * merged162$logFC_cort > 0) & # checks that mif and cort have same sign
  (merged162$logFC * merged162$logFC_cort > 0)  # checks that mif and 2h dex have the same sign

rnames_flipped_cat1 <- merged162 %>% dplyr::filter(category1 == TRUE) %>% pull(rowname)

# fig 6c.2a
plot_logFCs_162(rnames_flipped_cat1, "Category 1")
ggsave(filename="../data/00_paper_figures/6c2a.pdf", width = 18, height=5)
```



## 2. Only those genes which are significant in Dex 2h, ns in KH103>2h dex but are significant in the opposite direction as Dex 2h in mif>2h dex and cort113>2h dex

```{r, fig.width=7, fig.height=5}
merged162$category2 <- (merged162$FDR < 0.05) & 
  (merged162$FDR_KH > 0.05) & 
  (merged162$FDR_MIF < 0.05) & (merged162$FDR_cort < 0.05) & 
  (merged162$logFC_MIF * merged162$logFC_cort > 0) & # checks that mif and cort have same sign
  (merged162$logFC * merged162$logFC_cort < 0)  # checks that mif and 2h dex have different sign

rnames_flipped_cat2 <- merged162 %>% dplyr::filter(category2 == TRUE) %>% pull(rowname)

# fig 6c.2b
plot_logFCs_162(rnames_flipped_cat2, "Category 2")
ggsave(filename="../data/00_paper_figures/6c2b.pdf", width = 7, height=5)
```


## 3. Only those genes which are significant in Dex 2h, ns or significant in same direction as Dex 2h for mif>2h dex and cort113>2h dex but are significant in the opposite direction as Dex 2h in KH-103>2h dex

```{r, fig.width=10, fig.height=5}
merged162$category3 <- (merged162$FDR < 0.05) & 
  ((merged162$FDR_MIF < 0.05) | (merged162$logFC * merged162$logFC_MIF > 0)) & # 2h DEX and MIF point in same direction
  ((merged162$FDR_cort < 0.05) | (merged162$logFC * merged162$logFC_cort > 0)) & # 2h DEX and MIF point in same direction
  ((merged162$FDR_KH < 0.05) & (merged162$logFC * merged162$logFC_KH < 0)) # 2h DEX and KH have different logFC signs while KH is significant

rnames_flipped_cat3 <- merged162 %>% dplyr::filter(category3 == TRUE) %>% pull(rowname)

# fig 6c.2c
plot_logFCs_162(rnames_flipped_cat3, "Category 3")
ggsave(filename="../data/00_paper_figures/6c2c.pdf", width = 10, height=5)
```


## 4. Only those genes which are significant in Dex 2h, and are significant in the opposite direction as Dex 2h in all three conditions of KH-103>2h dex, MIF>2h dex, Cort113>2h dex

```{r, fig.width=7, fig.height=5}
merged162$category4 <- (merged162$FDR < 0.05) & 
  (merged162$logFC * merged162$logFC_KH < 0) & (merged162$FDR_KH < 0.05) & # KH is significant in other direction as 2h DEX
  (merged162$logFC * merged162$logFC_MIF < 0) & (merged162$FDR_MIF < 0.05) & # MIF is significant in other direction as 2h DEX
  (merged162$logFC * merged162$logFC_cort < 0) & (merged162$FDR_cort < 0.05) # cort is significant in other direction as 2h DEX

rnames_flipped_cat4 <- merged162 %>% dplyr::filter(category4 == TRUE) %>% pull(rowname)

# fig 6c.2d
plot_logFCs_162(rnames_flipped_cat4, "Category 4")
ggsave(filename="../data/00_paper_figures/6c2d.pdf", width = 7, height=5)
```

### Save file to excel

```{r save excel}
# setup excel file
wb <- createWorkbook()
# add worksheets and add data
addWorksheet(wb, sheetName = "2h>16h")
addWorksheet(wb, sheetName = "16h>2h")
writeData(wb, "2h>16h", merged216)
writeData(wb, "16h>2h", merged162)
# write final excel to disk
saveWorkbook(wb, "../docs/downloads/Q3_protac_flipped_DE.xlsx", overwrite=TRUE)
```

